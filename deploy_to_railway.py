#!/usr/bin/env python3
"""
Script de deployment autom√°tico a Railway
CLIP Comparador V2 - Deployment completo
"""

import os
import subprocess
import json
import sys
from pathlib import Path

def check_railway_cli():
    """Verificar si Railway CLI est√° instalado"""
    try:
        result = subprocess.run(['railway', '--version'], capture_output=True, text=True)
        if result.returncode == 0:
            print(f"‚úÖ Railway CLI instalado: {result.stdout.strip()}")
            return True
        else:
            print("‚ùå Railway CLI no encontrado")
            return False
    except FileNotFoundError:
        print("‚ùå Railway CLI no instalado")
        return False

def install_railway_cli():
    """Instalar Railway CLI"""
    print("üì¶ Instalando Railway CLI...")
    
    try:
        # Para Windows con npm
        result = subprocess.run(['npm', 'install', '-g', '@railway/cli'], 
                              capture_output=True, text=True)
        if result.returncode == 0:
            print("‚úÖ Railway CLI instalado exitosamente")
            return True
        else:
            print(f"‚ùå Error instalando Railway CLI: {result.stderr}")
            return False
    except FileNotFoundError:
        print("‚ùå npm no encontrado. Instala Node.js primero")
        return False

def railway_login():
    """Login a Railway"""
    print("üîê Iniciando sesi√≥n en Railway...")
    
    try:
        result = subprocess.run(['railway', 'login'], check=True)
        print("‚úÖ Login exitoso en Railway")
        return True
    except subprocess.CalledProcessError:
        print("‚ùå Error en login de Railway")
        return False

def create_railway_project():
    """Crear proyecto en Railway"""
    print("üöÄ Creando proyecto en Railway...")
    
    project_name = "clip-comparador-v2"
    
    try:
        # Crear proyecto
        result = subprocess.run(['railway', 'new', project_name], 
                              capture_output=True, text=True, input='y\n')
        
        if result.returncode == 0:
            print(f"‚úÖ Proyecto '{project_name}' creado")
            return True
        else:
            print(f"‚ö†Ô∏è Proyecto puede ya existir: {result.stderr}")
            # Intentar conectar a proyecto existente
            return link_existing_project()
            
    except Exception as e:
        print(f"‚ùå Error creando proyecto: {e}")
        return False

def link_existing_project():
    """Conectar a proyecto existente"""
    print("üîó Conectando a proyecto existente...")
    
    try:
        result = subprocess.run(['railway', 'link'], check=True)
        print("‚úÖ Conectado a proyecto Railway")
        return True
    except subprocess.CalledProcessError:
        print("‚ùå Error conectando a proyecto")
        return False

def add_postgresql():
    """Agregar PostgreSQL al proyecto"""
    print("üêò Agregando PostgreSQL...")
    
    try:
        result = subprocess.run(['railway', 'add', 'postgresql'], 
                              capture_output=True, text=True)
        if result.returncode == 0:
            print("‚úÖ PostgreSQL agregado al proyecto")
            return True
        else:
            print("‚ö†Ô∏è PostgreSQL puede ya estar agregado")
            return True
    except Exception as e:
        print(f"‚ùå Error agregando PostgreSQL: {e}")
        return False

def add_redis():
    """Agregar Redis al proyecto (opcional)"""
    print("üì¶ Agregando Redis...")
    
    try:
        result = subprocess.run(['railway', 'add', 'redis'], 
                              capture_output=True, text=True)
        if result.returncode == 0:
            print("‚úÖ Redis agregado al proyecto")
            return True
        else:
            print("‚ö†Ô∏è Redis puede ya estar agregado")
            return True
    except Exception as e:
        print(f"‚ùå Error agregando Redis: {e}")
        return False

def set_environment_variables(config):
    """Configurar variables de entorno"""
    print("‚öôÔ∏è Configurando variables de entorno...")
    
    variables = {
        'FLASK_ENV': 'production',
        'FLASK_DEBUG': 'False',
        'SECRET_KEY': config['secret_key'],
        'CLOUDINARY_CLOUD_NAME': config['cloudinary_cloud_name'],
        'CLOUDINARY_API_KEY': config['cloudinary_api_key'],
        'CLOUDINARY_API_SECRET': config['cloudinary_api_secret'],
        'APP_URL': 'https://clip-comparador-v2.railway.app',
        'CLIP_MODEL_NAME': 'ViT-B/16',
        'LOG_LEVEL': 'INFO'
    }
    
    for key, value in variables.items():
        try:
            result = subprocess.run(['railway', 'variables', 'set', f'{key}={value}'], 
                                  capture_output=True, text=True)
            if result.returncode == 0:
                print(f"   ‚úÖ {key} configurada")
            else:
                print(f"   ‚ùå Error configurando {key}: {result.stderr}")
        except Exception as e:
            print(f"   ‚ùå Error con {key}: {e}")

def create_railway_toml():
    """Crear archivo railway.toml para configuraci√≥n"""
    
    toml_content = """[build]
builder = "NIXPACKS"

[deploy]
healthcheckPath = "/"
healthcheckTimeout = 300
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[[services]]
name = "clip-admin-backend"
source = "clip_admin_backend"

[services.variables]
FLASK_ENV = "production"
FLASK_DEBUG = "False"

[[services.domains]]
"""

    with open('railway.toml', 'w') as f:
        f.write(toml_content)
    
    print("‚úÖ railway.toml creado")

def create_dockerfiles():
    """Crear Dockerfiles optimizados para Railway"""
    
    # Dockerfile para backend admin
    admin_dockerfile = """FROM python:3.10-slim

WORKDIR /app

# Instalar dependencias del sistema
RUN apt-get update && apt-get install -y \\
    gcc \\
    g++ \\
    && rm -rf /var/lib/apt/lists/*

# Copiar requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copiar aplicaci√≥n
COPY clip_admin_backend/ ./clip_admin_backend/
COPY shared/ ./shared/

WORKDIR /app/clip_admin_backend

# Variables de entorno
ENV FLASK_APP=app.py
ENV FLASK_ENV=production
ENV PYTHONPATH=/app

# Puerto
EXPOSE 5000

# Comando de inicio
CMD ["python", "app.py"]
"""

    os.makedirs('clip_admin_backend', exist_ok=True)
    with open('clip_admin_backend/Dockerfile', 'w') as f:
        f.write(admin_dockerfile)
    
    print("‚úÖ Dockerfile para admin backend creado")

def create_procfile():
    """Crear Procfile para Railway"""
    
    procfile_content = """web: cd clip_admin_backend && python app.py
"""

    with open('Procfile', 'w') as f:
        f.write(procfile_content)
    
    print("‚úÖ Procfile creado")

def run_database_migration():
    """Ejecutar migraci√≥n de base de datos"""
    print("üóÑÔ∏è Ejecutando migraci√≥n de base de datos...")
    
    try:
        # Obtener URL de PostgreSQL de Railway
        result = subprocess.run(['railway', 'variables'], 
                              capture_output=True, text=True)
        
        if 'DATABASE_URL' in result.stdout:
            print("‚úÖ PostgreSQL disponible")
            
            # Ejecutar script de estructura
            structure_file = None
            import_file = None
            
            for file in os.listdir('.'):
                if file.endswith('_postgresql_structure.sql'):
                    structure_file = file
                if file.endswith('_import_to_postgresql.py'):
                    import_file = file
            
            if structure_file and import_file:
                print(f"üìä Ejecutando migraci√≥n con {structure_file}")
                
                # Ejecutar importaci√≥n de datos
                result = subprocess.run(['python', import_file], 
                                      capture_output=True, text=True)
                
                if result.returncode == 0:
                    print("‚úÖ Migraci√≥n de datos completada")
                    return True
                else:
                    print(f"‚ùå Error en migraci√≥n: {result.stderr}")
                    return False
            else:
                print("‚ö†Ô∏è Archivos de migraci√≥n no encontrados")
                return False
        else:
            print("‚ùå DATABASE_URL no disponible")
            return False
            
    except Exception as e:
        print(f"‚ùå Error en migraci√≥n: {e}")
        return False

def deploy_to_railway():
    """Deploy a Railway"""
    print("üöÄ Iniciando deployment a Railway...")
    
    try:
        result = subprocess.run(['railway', 'deploy'], 
                              capture_output=True, text=True)
        
        if result.returncode == 0:
            print("‚úÖ Deployment exitoso!")
            
            # Obtener URL del deployment
            url_result = subprocess.run(['railway', 'domain'], 
                                      capture_output=True, text=True)
            
            if url_result.returncode == 0:
                print(f"üåê URL de la aplicaci√≥n: {url_result.stdout.strip()}")
            
            return True
        else:
            print(f"‚ùå Error en deployment: {result.stderr}")
            return False
            
    except Exception as e:
        print(f"‚ùå Error en deployment: {e}")
        return False

def main():
    """Funci√≥n principal de deployment"""
    print("üöÇ DEPLOYMENT AUTOM√ÅTICO A RAILWAY")
    print("CLIP Comparador V2 - Sistema Completo")
    print("=" * 50)
    
    # Verificar Railway CLI
    if not check_railway_cli():
        if not install_railway_cli():
            print("‚ùå No se pudo instalar Railway CLI")
            return False
    
    # Solicitar configuraci√≥n
    print("\nüìã CONFIGURACI√ìN NECESARIA:")
    config = {}
    
    config['secret_key'] = input("Secret Key para Flask (deja vac√≠o para generar): ").strip()
    if not config['secret_key']:
        import secrets
        config['secret_key'] = secrets.token_urlsafe(32)
        print(f"üîë Secret Key generada: {config['secret_key']}")
    
    config['cloudinary_cloud_name'] = input("Cloudinary Cloud Name: ").strip()
    config['cloudinary_api_key'] = input("Cloudinary API Key: ").strip()
    config['cloudinary_api_secret'] = input("Cloudinary API Secret: ").strip()
    
    if not all(config.values()):
        print("‚ùå Faltan datos de configuraci√≥n")
        return False
    
    # Proceso de deployment
    steps = [
        ("üîê Login a Railway", railway_login),
        ("üöÄ Crear/conectar proyecto", create_railway_project),
        ("üêò Agregar PostgreSQL", add_postgresql),
        ("üì¶ Agregar Redis", add_redis),
        ("‚öôÔ∏è Configurar variables", lambda: set_environment_variables(config)),
        ("üìÑ Crear archivos de deployment", create_railway_toml),
        ("üê≥ Crear Dockerfiles", create_dockerfiles),
        ("üìù Crear Procfile", create_procfile),
        ("üóÑÔ∏è Migrar base de datos", run_database_migration),
        ("üöÄ Deploy aplicaci√≥n", deploy_to_railway)
    ]
    
    for description, step_func in steps:
        print(f"\n{description}...")
        try:
            if not step_func():
                print(f"‚ùå Fall√≥: {description}")
                return False
        except Exception as e:
            print(f"‚ùå Error en {description}: {e}")
            return False
    
    print("\nüéâ ¬°DEPLOYMENT COMPLETADO EXITOSAMENTE!")
    print("üåê Tu aplicaci√≥n est√° ahora disponible en Railway")
    print("üìä Verifica el deployment en: https://railway.app/dashboard")
    
    return True

if __name__ == "__main__":
    success = main()
    if not success:
        print("\nüí• Deployment fall√≥. Revisar errores arriba.")
        sys.exit(1)
    else:
        print("\nüéä ¬°Sistema CLIP Comparador V2 desplegado en Railway!")