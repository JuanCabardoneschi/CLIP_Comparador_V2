{% extends "layouts/base.html" %}

{% block title %}Editar {{ product.name }}{% endblock %}

{% block extra_css %}
<style>
.form-section {
    background-color: #fff;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.section-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.current-images {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.image-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.image-item.primary {
    border-color: #198754;
    box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.25);
}

.image-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
}

.image-controls {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 3px;
}

.image-controls button {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: none;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.primary-badge {
    position: absolute;
    bottom: 5px;
    left: 5px;
    background: rgba(25, 135, 84, 0.9);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: bold;
}

.tag-input {
    position: relative;
}

.tag-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 150px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.tag-suggestion {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.tag-suggestion:hover {
    background-color: #f8f9fa;
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}
/* Masonry columns para atributos dinámicos: elimina huecos sin hardcodear */
.attributes-grid {
    column-count: 2;
    column-gap: 1.5rem;
}
.attributes-grid .attr-item {
    break-inside: avoid;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-pencil"></i> Editar Producto</h2>
            <p class="text-muted mb-0">{{ product.name }}</p>
        </div>
        <div>
            <a href="{{ url_for('products.view', product_id=product.id) }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-eye"></i> Ver Producto
            </a>
            <a href="{{ url_for('products.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <form method="POST" id="editProductForm">
        <div class="row">
            <div class="col-lg-6">
                <div class="form-section">
                    <h5 class="section-title">
                        <i class="bi bi-info-circle"></i> Datos del Producto
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ product.name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category_id" class="form-label">Categoría *</label>
                                <select class="form-select" id="category_id" name="category_id" required>
                                    <option value="">Seleccionar categoría...</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}" {% if category.id == product.category_id %}selected{% endif %}>{{ category.name }}{% if category.name_en %} ({{ category.name_en }}){% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="description" class="form-label">Descripción</label>
                                <textarea class="form-control" id="description" name="description" rows="3">{{ product.description or '' }}</textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sku" class="form-label">SKU / Código</label>
                                <input type="text" class="form-control" id="sku" name="sku" value="{{ product.sku or '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="price" class="form-label">Precio</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" value="{{ product.price or '' }}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stock" class="form-label">Stock</label>
                                <input type="number" class="form-control" id="stock" name="stock" min="0" value="{{ product.stock or 0 }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tags" class="form-label">Tags</label>
                                <div class="tag-input">
                                    <input type="text" class="form-control" id="tags" name="tags" value="{{ product.tags or '' }}" placeholder="algodón, azul, casual">
                                    <div id="tagSuggestions" class="tag-suggestions"></div>
                                </div>
                                <div class="form-text">Separar múltiples tags con comas</div>
                            </div>
                        </div>
                        {% if attribute_configs %}
                            <div class="attributes-grid">
                            {% for config in attribute_configs %}
                                <div class="attr-item">
                                    <div class="mb-3">
                                        <label for="attr_{{ config.key }}" class="form-label">{{ config.label }}{% if config.required %}<span class="text-danger">*</span>{% endif %}</label>
                                        {% if config.type == 'text' %}
                                            <input type="text" class="form-control" id="attr_{{ config.key }}" name="attr_{{ config.key }}" value="{{ product.attributes.get(config.key, '') if product.attributes else '' }}" {% if config.required %}required{% endif %} placeholder="{{ config.label }}">
                                        {% elif config.type == 'number' %}
                                            <input type="number" class="form-control" id="attr_{{ config.key }}" name="attr_{{ config.key }}" step="any" value="{{ product.attributes.get(config.key, '') if product.attributes else '' }}" {% if config.required %}required{% endif %} placeholder="{{ config.label }}">
                                        {% elif config.type == 'date' %}
                                            <input type="date" class="form-control" id="attr_{{ config.key }}" name="attr_{{ config.key }}" value="{{ product.attributes.get(config.key, '') if product.attributes else '' }}" {% if config.required %}required{% endif %}>
                                        {% elif config.type == 'list' %}
                                            {% set is_multiple = config.options['multiple'] if config.options and 'multiple' in config.options else False %}
                                            {% set values = config.options['values'] if config.options and 'values' in config.options else config.options %}
                                            {# Coaccionar a lista si es multiple y el valor guardado es string legacy #}
                                            {% if is_multiple %}
                                                {% set raw_val = product.attributes.get(config.key) if product.attributes else [] %}
                                                {% if raw_val is string %}
                                                    {% set current_value = [raw_val] %}
                                                {% else %}
                                                    {% set current_value = raw_val or [] %}
                                                {% endif %}
                                            {% else %}
                                                {% set current_value = product.attributes.get(config.key, '') if product.attributes else '' %}
                                            {% endif %}
                                            <select class="form-select" id="attr_{{ config.key }}" name="attr_{{ config.key }}{% if is_multiple %}[]{% endif %}" {% if is_multiple %}multiple{% endif %} {% if config.required %}required{% endif %}>
                                                <option value="">Seleccionar...</option>
                                                {% if values %}
                                                    {% for option in values %}
                                                        {% if is_multiple %}
                                                            <option value="{{ option }}" {% if current_value and option in current_value %}selected{% endif %}>{{ option }}</option>
                                                        {% else %}
                                                            <option value="{{ option }}" {% if option == current_value %}selected{% endif %}>{{ option }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </select>
                                            {% if is_multiple %}
                                                <div class="form-text">Puedes seleccionar varias opciones con Ctrl o Shift</div>
                                            {% endif %}
                                        {% elif config.type == 'url' %}
                                            <input type="url" class="form-control" id="attr_{{ config.key }}" name="attr_{{ config.key }}" value="{{ product.attributes.get(config.key, '') if product.attributes else '' }}" {% if config.required %}required{% endif %} placeholder="https://...">
                                            <div class="form-text">URL completa del producto</div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                            </div>
                        {% endif %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if product.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="is_active">Producto activo</label>
                                </div>
                                <div class="form-text">Los productos inactivos no aparecen en las búsquedas</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gestión de imágenes -->
            <div class="col-lg-6">
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="section-title mb-0">
                            <i class="bi bi-images"></i> Imágenes Actuales ({{ product.images.count() }})
                        </h5>
                        <a href="{{ url_for('products.view', product_id=product.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-plus-circle"></i> Gestionar Imágenes
                        </a>
                    </div>

                    {% if product.images.count() > 0 %}
                        <div class="current-images">
                            {% for image in product.images %}
                            <div class="image-item {% if image.is_primary %}primary{% endif %}">
                                <img src="{{ image.thumbnail_url }}"
                                     alt="Imagen {{ loop.index }}">

                                <div class="image-controls">
                                    {% if not image.is_primary %}
                                        <button type="button"
                                                class="btn btn-success"
                                                onclick="setPrimaryImage('{{ image.id }}')"
                                                title="Establecer como principal">
                                            <i class="bi bi-star"></i>
                                        </button>
                                    {% endif %}
                                    <button type="button"
                                            class="btn btn-danger"
                                            onclick="confirmDeleteImage('{{ image.id }}', '{{ image.original_filename or image.filename }}')"
                                            title="Eliminar imagen">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>

                                {% if image.is_primary %}
                                    <div class="primary-badge">Principal</div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <div class="mt-3 p-3 bg-light rounded">
                            <h6><i class="bi bi-info-circle"></i> Gestión de Imágenes</h6>
                            <p class="small mb-2">Para gestionar las imágenes (agregar, eliminar, cambiar principal),
                            ve a la <a href="{{ url_for('products.view', product_id=product.id) }}">página de visualización del producto</a>.</p>
                            <p class="small mb-0 text-muted">
                                • Imagen principal: Aparece en listados y búsquedas<br>
                                • Múltiples imágenes: Mejoran la experiencia del usuario<br>
                                • Embeddings: Se generan automáticamente para búsqueda visual
                            </p>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                            <h6 class="text-muted mt-2">Sin imágenes</h6>
                            <p class="text-muted small">
                                Ve a la <a href="{{ url_for('products.view', product_id=product.id) }}">página del producto</a>
                                para agregar imágenes.
                            </p>
                        </div>
                    {% endif %}
                </div>

                <!-- Información adicional -->
                <div class="form-section">
                    <h5 class="section-title">
                        <i class="bi bi-clock"></i> Información del Sistema
                    </h5>

                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Creado:</small><br>
                            <span class="small">{{ product.created_at.strftime('%d/%m/%Y %H:%M') if product.created_at else '-' }}</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Actualizado:</small><br>
                            <span class="small">{{ product.updated_at.strftime('%d/%m/%Y %H:%M') if product.updated_at else '-' }}</span>
                        </div>
                    </div>

                    <hr class="my-3">

                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">ID:</small><br>
                            <code class="small">{{ product.id }}</code>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Cliente:</small><br>
                            <span class="small">{{ current_user.client.name if current_user.client else 'N/A' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="form-section">
            <div class="d-flex justify-content-between">
                <div>
                    <a href="{{ url_for('products.view', product_id=product.id) }}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </a>
                    <a href="{{ url_for('products.index') }}" class="btn btn-outline-info">
                        <i class="bi bi-list"></i> Ver Todos
                    </a>
                </div>
                <div>
                    <button type="button"
                            class="btn btn-outline-danger me-2"
                            onclick="confirmDelete('{{ product.id }}', '{{ product.name }}')">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        <i class="bi bi-check-circle"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modales de confirmación -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar el producto <strong id="productName"></strong>?</p>
                <p class="text-danger small">Esta acción también eliminará todas las imágenes asociadas y no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar eliminación de imagen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar la imagen <strong id="imageName"></strong>?</p>
                <p class="text-danger small">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteImage">Eliminar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-resize del textarea
    const descriptionTextarea = document.getElementById('description');
    descriptionTextarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // Trigger inicial para ajustar altura
    descriptionTextarea.dispatchEvent(new Event('input'));

    // Validación del formulario
    document.getElementById('editProductForm').addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();
        const categoryId = document.getElementById('category_id').value;

        if (!name) {
            e.preventDefault();
            alert('El nombre del producto es obligatorio');
            return;
        }

        if (!categoryId) {
            e.preventDefault();
            alert('Debe seleccionar una categoría');
            return;
        }

        // Cambiar texto del botón durante el envío
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';
        saveBtn.disabled = true;
    });

    // Sugerencias de tags (simulado - en producción vendría del backend)
    const commonTags = [
        'algodón', 'azul', 'casual', 'elegante', 'cómodo', 'deportivo',
        'manga larga', 'manga corta', 'cuello redondo', 'cuello V',
        'slim fit', 'regular fit', 'oversized', 'vintage', 'moderno'
    ];

    const tagsInput = document.getElementById('tags');
    const suggestions = document.getElementById('tagSuggestions');

    tagsInput.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        const lastTag = value.split(',').pop().trim();

        if (lastTag.length < 2) {
            suggestions.style.display = 'none';
            return;
        }

        const matches = commonTags.filter(tag =>
            tag.toLowerCase().includes(lastTag) &&
            !value.includes(tag)
        );

        if (matches.length > 0) {
            suggestions.innerHTML = matches.map(tag =>
                `<div class="tag-suggestion" onclick="addTag('${tag}')">${tag}</div>`
            ).join('');
            suggestions.style.display = 'block';
        } else {
            suggestions.style.display = 'none';
        }
    });

    tagsInput.addEventListener('blur', function() {
        // Delay para permitir clicks en sugerencias
        setTimeout(() => suggestions.style.display = 'none', 200);
    });
});

function addTag(tag) {
    const tagsInput = document.getElementById('tags');
    const currentTags = tagsInput.value.split(',').map(t => t.trim());

    // Remover el último tag incompleto
    currentTags.pop();

    // Agregar el nuevo tag
    currentTags.push(tag);

    tagsInput.value = currentTags.join(', ') + ', ';
    tagsInput.focus();

    document.getElementById('tagSuggestions').style.display = 'none';
}

function setPrimaryImage(imageId) {
    fetch(`/products/{{ product.id }}/images/${imageId}/set-primary`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al establecer imagen principal');
    });
}

function confirmDelete(productId, productName) {
    document.getElementById('productName').textContent = productName;
    document.getElementById('deleteForm').action = `/products/${productId}/delete`;

    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function confirmDeleteImage(imageId, imageName) {
    document.getElementById('imageName').textContent = imageName;

    document.getElementById('confirmDeleteImage').onclick = function() {
        deleteImage(imageId);
    };

    const modal = new bootstrap.Modal(document.getElementById('deleteImageModal'));
    modal.show();
}

function deleteImage(imageId) {
    fetch(`/products/{{ product.id }}/images/${imageId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar imagen');
    });
}
</script>
{% endblock %}
