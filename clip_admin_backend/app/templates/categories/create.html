{% extends "layouts/base.html" %}

{% block title %}Nueva Categor√≠a{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">Nueva Categor√≠a</h1>
        <p class="text-muted">
            Crea una nueva categor√≠a para:
            <strong class="text-primary">
                <i class="bi bi-building me-1"></i>
                {{ current_user.client.name if current_user.client else 'Cliente no asignado' }}
            </strong>
        </p>
    </div>
    <a href="{{ url_for('categories.index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>
        Volver a Categor√≠as
    </a>
</div>

<!-- Informaci√≥n del cliente -->
<div class="alert alert-primary mb-4">
    <div class="d-flex align-items-center">
        <div class="me-3">
            <i class="bi bi-building fs-4"></i>
        </div>
        <div>
            <div class="fw-medium">Cliente: {{ current_user.client.name if current_user.client else 'No asignado' }}</div>
            <div class="small">
                Esta categor√≠a ser√° creada exclusivamente para este cliente y solo ser√° visible en su cat√°logo.
                {% if current_user.client %}
                <br><span class="text-muted">ID del cliente: {{ current_user.client.id[:8] }}...</span>
                {% endif %}
            </div>
        </div>
        {% if current_user.client %}
        <div class="ms-auto">
            <span class="badge bg-success">
                <i class="bi bi-check-circle me-1"></i>
                Cliente Asignado
            </span>
        </div>
        {% else %}
        <div class="ms-auto">
            <span class="badge bg-warning">
                <i class="bi bi-exclamation-triangle me-1"></i>
                Sin Cliente
            </span>
        </div>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Informaci√≥n de la Categor√≠a</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="categoryForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    Nombre de la Categor√≠a <span class="text-danger">*</span>
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="name"
                                       name="name"
                                       required
                                       placeholder="Ej: Camisetas, Pantalones, Zapatos..."
                                       maxlength="100">
                                <div class="form-text">Nombre descriptivo para la categor√≠a (m√°ximo 100 caracteres)</div>
                            </div>

                            <div class="mb-3">
                                <label for="name_en" class="form-label">
                                    <i class="bi bi-translate me-1"></i>
                                    Nombre en Ingl√©s (para CLIP) <span class="text-danger">*</span>
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="name_en"
                                       name="name_en"
                                       required
                                       placeholder="Se completar√° autom√°ticamente con la traducci√≥n..."
                                       maxlength="100">
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Se traduce autom√°ticamente, pero puedes editarlo para mayor precisi√≥n
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="alternative_terms" class="form-label">
                                    <i class="bi bi-tags me-1"></i>
                                    T√©rminos Alternativos
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="alternative_terms"
                                       name="alternative_terms"
                                       placeholder="Ej: shirt, t-shirt, blouse, top (separados por coma)"
                                       maxlength="200">
                                <div class="form-text">
                                    Sin√≥nimos y variaciones en ingl√©s para mejorar la precisi√≥n de CLIP (separados por comas)
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="color" class="form-label">Color Identificativo</label>
                                <div class="d-flex align-items-center">
                                    <input type="color"
                                           class="form-control form-control-color me-2"
                                           id="color"
                                           name="color"
                                           value="#007bff"
                                           style="width: 50px; height: 38px;">
                                    <input type="text"
                                           class="form-control"
                                           id="colorHex"
                                           value="#007bff"
                                           placeholder="#007bff"
                                           pattern="^#[0-9A-Fa-f]{6}$">
                                </div>
                                <div class="form-text">Color para identificar visualmente la categor√≠a</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control"
                                  id="description"
                                  name="description"
                                  rows="3"
                                  placeholder="Descripci√≥n opcional de la categor√≠a..."
                                  maxlength="500"></textarea>
                        <div class="form-text">
                            Descripci√≥n opcional para proporcionar m√°s detalles sobre la categor√≠a (m√°ximo 500 caracteres)
                        </div>
                    </div>

                    <!-- Configuraci√≥n CLIP -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-eye me-2"></i>
                                Configuraci√≥n de B√∫squeda Visual (CLIP)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info small mb-3">
                                <i class="bi bi-globe me-2"></i>
                                <strong>Optimizaci√≥n CLIP:</strong>
                                <ul class="mb-1">
                                    <li><strong>Traducci√≥n autom√°tica:</strong> Se traduce el espa√±ol al ingl√©s usando el contexto de la industria</li>
                                    <li><strong>T√©rminos alternativos:</strong> Agrega sin√≥nimos para mejorar las b√∫squedas</li>
                                    <li><strong>Caracter√≠sticas visuales:</strong> Especifica elementos que CLIP debe identificar</li>
                                </ul>
                                <small class="text-muted">Ej: "delantal" ‚Üí "apron" + t√©rminos: "kitchen apron, chef apron"</small>
                            </div>

                            <div class="mb-3">
                                <label for="visual_features" class="form-label">
                                    Caracter√≠sticas Visuales <span class="text-muted">(Opcional)</span>
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="visual_features"
                                       name="visual_features"
                                       placeholder="Ej: collar, mangas, botones, tejido..."
                                       maxlength="200">
                                <div class="form-text">
                                    Especifica qu√© elementos visuales debe buscar CLIP en las im√°genes de esta categor√≠a
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="confidence_threshold" class="form-label">
                                    Umbral de Confianza
                                </label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="range"
                                               class="form-range"
                                               id="confidence_threshold"
                                               name="confidence_threshold"
                                               min="0.5"
                                               max="1.0"
                                               step="0.05"
                                               value="0.75"
                                               oninput="document.getElementById('thresholdValue').textContent = this.value">
                                    </div>
                                    <div class="col-md-6">
                                        <span class="badge bg-primary">
                                            <span id="thresholdValue">0.75</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="form-text">
                                    Nivel m√≠nimo de similaridad para considerar una coincidencia v√°lida (0.5 = permisivo, 1.0 = estricto)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="is_active"
                                   name="is_active"
                                   checked>
                            <label class="form-check-label" for="is_active">
                                <strong>Categor√≠a activa</strong>
                            </label>
                            <div class="form-text">
                                Las categor√≠as activas aparecen disponibles para asignar a productos
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('categories.index') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-2"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>
                            Crear Categor√≠a
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Vista previa -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-eye me-2"></i>
                    Vista Previa
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3" id="preview">
                    <div class="color-indicator me-3"
                         id="previewColor"
                         style="width: 30px; height: 30px; border-radius: 50%; background-color: #007bff;"></div>
                    <div>
                        <div class="fw-medium" id="previewName">Nombre de la categor√≠a</div>
                        <div class="text-muted small" id="previewDescription">Descripci√≥n de la categor√≠a</div>
                    </div>
                </div>
                <div class="mb-2">
                    <span class="badge bg-success" id="previewStatus">
                        <i class="bi bi-check-circle me-1"></i>
                        Activa
                    </span>
                </div>
                <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    As√≠ se ver√° la categor√≠a en el listado
                </div>
            </div>
        </div>

        <!-- Consejos -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightbulb me-2"></i>
                    Consejos
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="bi bi-check text-success me-2"></i>
                        Usa nombres descriptivos y claros
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success me-2"></i>
                        Elige colores distintivos para cada categor√≠a
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success me-2"></i>
                        Agrupa productos similares en la misma categor√≠a
                    </li>
                    <li class="mb-0">
                        <i class="bi bi-check text-success me-2"></i>
                        Puedes desactivar categor√≠as temporalmente
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('üöÄ Script de categor√≠as cargado');

// Funci√≥n de traducci√≥n autom√°tica
let translationTimeout;
function autoTranslate() {
    const spanishName = document.getElementById('name').value.trim();
    const englishField = document.getElementById('name_en');

    if (!spanishName) {
        englishField.value = '';
        englishField.placeholder = 'Se completar√° autom√°ticamente con la traducci√≥n...';
        return;
    }

    // Debounce para evitar demasiadas llamadas
    clearTimeout(translationTimeout);
    translationTimeout = setTimeout(() => {
        // Mostrar indicador de carga
        englishField.placeholder = 'Traduciendo...';
        englishField.disabled = true;

        // Hacer llamada AJAX al backend para traducir
        fetch('/api/translate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                text: spanishName,
                target_language: 'en'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                englishField.value = data.translated_text;
                englishField.placeholder = 'Puedes editar la traducci√≥n autom√°tica...';
            } else {
                englishField.placeholder = 'Error en traducci√≥n - ingresa manualmente';
                console.error('Error en traducci√≥n:', data.error);
            }
            englishField.disabled = false;
        })
        .catch(error => {
            console.error('Error en traducci√≥n:', error);
            englishField.placeholder = 'Error en traducci√≥n - ingresa manualmente';
            englishField.disabled = false;
        });

    }, 1000);
}

// Sincronizar selector de color con input de texto
document.getElementById('color').addEventListener('input', function() {
    document.getElementById('colorHex').value = this.value;
    updatePreview();
});

document.getElementById('colorHex').addEventListener('input', function() {
    const color = this.value;
    if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
        document.getElementById('color').value = color;
        updatePreview();
    }
});

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    // Agregar event listeners para traducci√≥n autom√°tica
    const nameField = document.getElementById('name');
    const nameEnField = document.getElementById('name_en');

    if (nameField) {
        nameField.addEventListener('input', autoTranslate);
        nameField.addEventListener('blur', autoTranslate);
        nameField.addEventListener('input', updatePreview);
    }

    // Otros event listeners
    const descField = document.getElementById('description');
    const activeField = document.getElementById('is_active');

    if (descField) descField.addEventListener('input', updatePreview);
    if (activeField) activeField.addEventListener('change', updatePreview);
});

// Tambi√©n agregar event listeners de forma tradicional como backup
// Agregar event listeners para traducci√≥n autom√°tica
if (document.getElementById('name')) {
    document.getElementById('name').addEventListener('input', autoTranslate);
    document.getElementById('name').addEventListener('blur', autoTranslate);
}

// Actualizar vista previa en tiempo real
if (document.getElementById('name')) document.getElementById('name').addEventListener('input', updatePreview);
if (document.getElementById('description')) document.getElementById('description').addEventListener('input', updatePreview);
if (document.getElementById('is_active')) document.getElementById('is_active').addEventListener('change', updatePreview);

function updatePreview() {
    const name = document.getElementById('name').value || 'Nombre de la categor√≠a';
    const description = document.getElementById('description').value || 'Descripci√≥n de la categor√≠a';
    const color = document.getElementById('color').value;
    const isActive = document.getElementById('is_active').checked;

    document.getElementById('previewName').textContent = name;
    document.getElementById('previewDescription').textContent = description;
    document.getElementById('previewColor').style.backgroundColor = color;

    const statusBadge = document.getElementById('previewStatus');
    if (isActive) {
        statusBadge.className = 'badge bg-success';
        statusBadge.innerHTML = '<i class="bi bi-check-circle me-1"></i>Activa';
    } else {
        statusBadge.className = 'badge bg-secondary';
        statusBadge.innerHTML = '<i class="bi bi-pause-circle me-1"></i>Inactiva';
    }
}

// Validaci√≥n del formulario
document.getElementById('categoryForm').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const colorHex = document.getElementById('colorHex').value;

    if (!name) {
        e.preventDefault();
        alert('El nombre de la categor√≠a es obligatorio');
        document.getElementById('name').focus();
        return;
    }

    if (!/^#[0-9A-Fa-f]{6}$/.test(colorHex)) {
        e.preventDefault();
        alert('El color debe tener un formato v√°lido (ej: #007bff)');
        document.getElementById('colorHex').focus();
        return;
    }
});

// Inicializar vista previa
updatePreview();
</script>
{% endblock %}
