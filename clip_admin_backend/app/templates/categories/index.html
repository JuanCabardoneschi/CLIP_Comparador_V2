{% extends "layouts/base.html" %}

{% block title %}Gestión de Categorías{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">Categorías</h1>
        <p class="text-muted">
            Organiza tus productos por categorías para:
            <strong class="text-primary">
                <i class="bi bi-building me-1"></i>
                {{ current_user.client.name if current_user.client else 'Cliente no asignado' }}
            </strong>
        </p>
    </div>
    <a href="{{ url_for('categories.create') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>
        Nueva Categoría
    </a>
</div>

<!-- Información del cliente -->
<div class="alert alert-info mb-4">
    <div class="d-flex align-items-center">
        <div class="me-3">
            <i class="bi bi-info-circle fs-4"></i>
        </div>
        <div>
            <div class="fw-medium">Gestión por Cliente</div>
            <div class="small">
                Estás gestionando las categorías para el cliente
                <strong>{{ current_user.client.name if current_user.client else 'No asignado' }}</strong>.
                Solo verás y podrás crear categorías asociadas a este cliente.
            </div>
        </div>
    </div>
</div>

    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="h4 mb-0">{{ total_categories or categories|length }}</div>
                            <div class="small">Total Categorías</div>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-tags fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="h4 mb-0">{{ active_categories or (categories|selectattr('is_active')|list|length) }}</div>
                            <div class="small">Activas</div>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="h4 mb-0">{{ inactive_categories or (categories|rejectattr('is_active')|list|length) }}</div>
                            <div class="small">Inactivas</div>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-pause-circle fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="h4 mb-0">{{ categories_with_products or 0 }}</div>
                            <div class="small">Con Productos</div>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-box fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" placeholder="Buscar categorías..." id="searchInput">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">Todos los estados</option>
                    <option value="active">Activas</option>
                    <option value="inactive">Inactivas</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="sortBy">
                    <option value="name">Ordenar por Nombre</option>
                    <option value="created">Fecha de Creación</option>
                    <option value="updated">Última Actualización</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Lista de categorías -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">Lista de Categorías</h5>
    </div>
    <div class="card-body p-0">
        {% if categories %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;">Color</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th style="width: 120px;">Estado</th>
                            <th style="width: 120px;">Productos</th>
                            <th style="width: 150px;">Fecha Creación</th>
                            <th style="width: 120px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category in categories %}
                        <tr class="category-row" data-category-id="{{ category.id }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="color-indicator me-2"
                                         style="width: 20px; height: 20px; border-radius: 50%; background-color: {{ category.color or '#007bff' }};"></div>
                                </div>
                            </td>
                            <td>
                                <div class="fw-medium">{{ category.name }}</div>
                                <small class="text-muted">ID: {{ category.id[:8] }}...</small>
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 300px;" title="{{ category.description or 'Sin descripción' }}">
                                    {{ category.description or 'Sin descripción' }}
                                </div>
                            </td>
                            <td>
                                {% if category.is_active %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i>
                                        Activa
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-pause-circle me-1"></i>
                                        Inactiva
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-info">
                                    {{ category.product_count or 0 }} producto{{ 's' if (category.product_count or 0) != 1 else '' }}
                                </span>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ category.created_at.strftime('%d/%m/%Y') if category.created_at else 'N/A' }}
                                </small>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('categories.edit', category_id=category.id) }}"
                                       class="btn btn-sm btn-outline-primary" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger"
                                            title="Eliminar"
                                            onclick="confirmDelete('{{ category.id }}', '{{ category.name }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <div class="mb-3">
                    <i class="bi bi-tags text-muted" style="font-size: 4rem;"></i>
                </div>
                <h5 class="text-muted">No hay categorías creadas</h5>
                <p class="text-muted">Comienza creando tu primera categoría para organizar tus productos</p>
                <a href="{{ url_for('categories.create') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>
                    Crear Primera Categoría
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar la categoría <strong id="categoryToDelete"></strong>?</p>
                <p class="text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" id="deleteForm" style="display: inline;">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filtros en tiempo real
document.getElementById('searchInput').addEventListener('input', filterCategories);
document.getElementById('statusFilter').addEventListener('change', filterCategories);
document.getElementById('sortBy').addEventListener('change', sortCategories);

function filterCategories() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('.category-row');

    rows.forEach(row => {
        const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        const description = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
        const isActive = row.querySelector('.badge.bg-success') !== null;

        let showRow = true;

        // Filtro de búsqueda
        if (searchTerm && !name.includes(searchTerm) && !description.includes(searchTerm)) {
            showRow = false;
        }

        // Filtro de estado
        if (statusFilter === 'active' && !isActive) {
            showRow = false;
        } else if (statusFilter === 'inactive' && isActive) {
            showRow = false;
        }

        row.style.display = showRow ? '' : 'none';
    });
}

function sortCategories() {
    const sortBy = document.getElementById('sortBy').value;
    const tbody = document.querySelector('tbody');
    const rows = Array.from(document.querySelectorAll('.category-row'));

    rows.sort((a, b) => {
        let aValue, bValue;

        switch(sortBy) {
            case 'name':
                aValue = a.querySelector('td:nth-child(2)').textContent.toLowerCase();
                bValue = b.querySelector('td:nth-child(2)').textContent.toLowerCase();
                break;
            case 'created':
                aValue = a.querySelector('td:nth-child(6)').textContent;
                bValue = b.querySelector('td:nth-child(6)').textContent;
                break;
            case 'updated':
                // Por ahora usar created
                aValue = a.querySelector('td:nth-child(6)').textContent;
                bValue = b.querySelector('td:nth-child(6)').textContent;
                break;
            default:
                return 0;
        }

        return aValue.localeCompare(bValue);
    });

    // Reordenar las filas
    rows.forEach(row => tbody.appendChild(row));
}

function confirmDelete(categoryId, categoryName) {
    document.getElementById('categoryToDelete').textContent = categoryName;
    document.getElementById('deleteForm').action = `/categories/${categoryId}/delete`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>
{% endblock %}
