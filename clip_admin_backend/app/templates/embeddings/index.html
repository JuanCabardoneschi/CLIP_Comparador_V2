{% extends "layouts/base.html" %}
{% set active_page = "embeddings" %}

{% block title %}Administraci√≥n de Embeddings CLIP{% endblock %}

{% block extra_head %}
<style>
/* CSS Version 2.0 - Fixed image sizes and layout */
.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.stats-card h3 {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 0;
}

.stats-card p {
    margin: 0;
    opacity: 0.9;
}

.embedding-item {
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    background: white;
    transition: all 0.3s ease;
    min-height: 120px;
    display: flex;
    align-items: center;
}

.embedding-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.embedding-item .d-flex {
    width: 100%;
    align-items: center !important;
}

.status-badge {
    font-size: 0.8rem;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-weight: 500;
}

.status-processed {
    background-color: #d4edda;
    color: #155724;
}

.status-pending {
    background-color: #fff3cd;
    color: #856404;
}

.status-failed {
    background-color: #f8d7da;
    color: #721c24;
}

.progress-container {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.image-thumbnail {
    width: 64px !important;
    height: 64px !important;
    object-fit: cover !important;
    border-radius: 8px !important;
    border: 2px solid #e9ecef !important;
    flex-shrink: 0 !important;
    display: block !important;
    max-width: 64px !important;
    max-height: 64px !important;
    min-width: 64px !important;
    min-height: 64px !important;
}

/* Forzar el tama√±o espec√≠fico dentro del contenedor */
.embedding-item .image-thumbnail {
    width: 64px !important;
    height: 64px !important;
}

.btn-process {
    background: linear-gradient(135deg, #007bff, #0056b3) !important;
    border: none !important;
    border-radius: 25px;
    padding: 0.5rem 1.5rem;
    color: white !important;
    font-weight: 600;
    transition: all 0.3s ease;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

.btn-process:hover {
    background: linear-gradient(135deg, #0056b3, #004085) !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4);
    color: white !important;
}

/* CSS espec√≠fico para el bot√≥n de procesar */
#process-pending-btn {
    background: linear-gradient(135deg, #007bff, #0056b3) !important;
    border: none !important;
    color: white !important;
    font-weight: 600 !important;
    border-radius: 25px !important;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3) !important;
}

#process-pending-btn:hover {
    background: linear-gradient(135deg, #0056b3, #004085) !important;
    color: white !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4) !important;
}

#process-pending-btn:disabled {
    background: #6c757d !important;
    color: white !important;
    opacity: 0.6 !important;
}

/* Estilos suaves para la barra de progreso */
.progress {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
}

.progress-bar {
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: all 0.3s ease;
}

/* Cuando est√° completa, color m√°s suave y elegante */
.progress-bar.complete,
#progress-bar.complete,
.progress-bar[style*="100%"] {
    background: linear-gradient(90deg, #198754, #0f5132) !important;
    animation: none !important;
    background-image: none !important;
}

/* Forzar el cambio cuando width es 100% */
.progress-bar[style*="width: 100%"],
#progress-bar[style*="width: 100%"] {
    background: linear-gradient(90deg, #198754, #0f5132) !important;
    animation: none !important;
    background-image: none !important;
}

/* Color suave durante el procesamiento */
.progress-bar.processing {
    background: linear-gradient(90deg, #0d6efd, #6610f2);
    animation: progress-bar-stripes 1s linear infinite;
}

/* Override del azul agresivo de Bootstrap */
.progress-bar-striped {
    background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
}

/* M√°xima especificidad para forzar el cambio de color cuando est√© al 100% */
body .progress .progress-bar[aria-valuenow="100"] {
    background: linear-gradient(90deg, #198754, #0f5132) !important;
    background-color: #198754 !important;
    background-image: none !important;
}

body .progress .progress-bar.bg-primary[style*="width: 100%"] {
    background: linear-gradient(90deg, #198754, #0f5132) !important;
    background-color: #198754 !important;
    background-image: none !important;
}

/* Especificidad m√°xima para sobrescribir progress-bar-striped y animated */
body .progress .progress-bar.progress-bar-striped.progress-bar-animated[style*="width: 100%"] {
    background: linear-gradient(90deg, #198754, #0f5132) !important;
    background-color: #198754 !important;
    background-image: none !important;
    animation: none !important;
}

.btn-danger-outline {
    border: 2px solid #dc3545;
    color: #dc3545;
    background: white;
    border-radius: 25px;
    padding: 0.5rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-danger-outline:hover {
    background: #dc3545;
    color: white;
    transform: translateY(-2px);
}

#processing-modal .modal-content {
    border-radius: 15px;
    border: none;
}

#processing-modal .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">üîÆ Administraci√≥n de Embeddings CLIP</h1>
            <p class="text-muted">Control total sobre el procesamiento de embeddings para b√∫squeda visual</p>
        </div>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="refreshStats()">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 id="total-count">{{ total_images }}</h3>
                <p>Total Im√°genes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 id="processed-count">{{ processed_images }}</h3>
                <p>Procesadas</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 id="pending-count">{{ pending_images }}</h3>
                <p>Pendientes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 id="failed-count">{{ failed_images }}</h3>
                <p>Errores</p>
            </div>
        </div>
    </div>

    <!-- Barra de Progreso -->
    <div class="progress-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">üìä Progreso de Procesamiento</h5>
            <span class="badge bg-primary" id="progress-percentage">
                {% if total_images > 0 %}
                    {{ "%.1f"|format((processed_images / total_images * 100)) }}%
                {% else %}
                    0%
                {% endif %}
            </span>
        </div>
        <div class="progress" style="height: 25px; border-radius: 15px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 id="progress-bar"
                 style="width: {% if total_images > 0 %}{{ (processed_images / total_images * 100) }}%{% else %}0%{% endif %}">
            </div>
        </div>
        <div class="text-center mt-2">
            <small class="text-muted" id="progress-text">
                {{ processed_images }} de {{ total_images }} im√°genes procesadas
            </small>
        </div>
    </div>

    <!-- Controles de Procesamiento -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üéõÔ∏è Controles de Procesamiento</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button id="process-pending-btn" class="btn btn-process w-100 mb-2" onclick="processPending()"
                                    {% if pending_images == 0 %}disabled{% endif %}
                                    style="background: linear-gradient(135deg, #007bff, #0056b3) !important; color: white !important; border: none !important;">
                                <i class="fas fa-play"></i> Procesar Pendientes
                                {% if pending_images > 0 %}
                                    <br><small>({{ pending_images }} im√°genes)</small>
                                {% endif %}
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-warning w-100 mb-2" onclick="clearFailed()"
                                    {% if failed_images == 0 %}disabled{% endif %}>
                                <i class="fas fa-eraser"></i> Limpiar Errores
                                {% if failed_images > 0 %}
                                    <br><small>({{ failed_images }} errores)</small>
                                {% endif %}
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-danger-outline w-100 mb-2" onclick="resetAll()"
                                    {% if total_images == 0 %}disabled{% endif %}>
                                <i class="fas fa-undo"></i> Resetear Todo
                                {% if total_images > 0 %}
                                    <br><small>({{ total_images }} im√°genes)</small>
                                {% endif %}
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-info w-100 mb-2" onclick="viewLogs()">
                                <i class="fas fa-list-alt"></i> Ver Logs
                                <br><small>Historial detallado</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Im√°genes -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">üìã Lista de Im√°genes ({{ images|length }})</h5>
        </div>
        <div class="card-body">
            {% if images %}
                <div class="row" id="images-container">
                    {% for image_data in images %}
                        {% set image = image_data[0] %}
                        {% set product_name = image_data.product_name %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="embedding-item">
                                <div class="d-flex align-items-center">
                                    <img src="{{ image.thumbnail_url }}"
                                         alt="{{ product_name }}"
                                         class="image-thumbnail me-3"
                                         style="width: 64px !important; height: 64px !important; object-fit: cover !important; flex-shrink: 0 !important;"
                                         onerror="this.src='{{ url_for('static', filename='img/no-image.svg') }}'">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ product_name[:30] }}{% if product_name|length > 30 %}...{% endif %}</h6>
                                        <small class="text-muted d-block">{{ image.filename }}</small>
                                        <div class="mt-2">
                                            {% if image.is_processed %}
                                                <span class="status-badge status-processed">
                                                    <i class="fas fa-check"></i> Procesada
                                                </span>
                                            {% elif image.upload_status == 'failed' %}
                                                <span class="status-badge status-failed">
                                                    <i class="fas fa-times"></i> Error
                                                </span>
                                            {% else %}
                                                <span class="status-badge status-pending">
                                                    <i class="fas fa-clock"></i> Pendiente
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="ms-2">
                                        {% if not image.is_processed and image.upload_status != 'failed' %}
                                            <button class="btn btn-sm btn-outline-primary"
                                                    onclick="processSingle('{{ image.id }}')">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        {% elif image.upload_status == 'failed' %}
                                            <button class="btn btn-sm btn-outline-warning"
                                                    onclick="retryImage('{{ image.id }}')">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-success" disabled>
                                                <i class="fas fa-check"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if image.error_message %}
                                    <div class="mt-2">
                                        <small class="text-danger">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            {{ image.error_message[:100] }}{% if image.error_message|length > 100 %}...{% endif %}
                                        </small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-images fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No hay im√°genes en el sistema</h5>
                    <p class="text-muted">Primero sube algunas im√°genes en la secci√≥n de productos</p>
                    <a href="{{ url_for('products.index') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Ir a Productos
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Procesamiento -->
<div class="modal fade" id="processing-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin"></i> Procesando Embeddings
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <p id="processing-message">Generando embeddings CLIP...</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         id="processing-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let processingModal;
let isProcessing = false;
let pollingInterval = null;

// Funciones globales - FUERA del DOMContentLoaded
function processPending() {
    console.log('üöÄ Iniciando processPending()');
    const pendingCount = parseInt(document.getElementById('pending-count').textContent);
    console.log('üìä Im√°genes pendientes:', pendingCount);

    if (pendingCount === 0) {
        showAlert('warning', 'No hay im√°genes pendientes para procesar');
        return;
    }

    if (!confirm(`¬øProcesar ${pendingCount} im√°genes pendientes?\n\nEsto puede tomar varios minutos.`)) {
        console.log('‚ùå Usuario cancel√≥ el procesamiento');
        return;
    }

    console.log('‚úÖ Usuario confirm√≥ el procesamiento');

    // Configurar estado de procesamiento
    isProcessing = true;
    processingModal.show();

    // Inicializar mensaje y barra de progreso
    document.getElementById('processing-message').textContent =
        `Procesando embeddings... 0/${pendingCount} (0%)`;

    // Iniciar polling para actualizaciones en tiempo real
    startPolling();

    const url = '{{ url_for("embeddings.process_pending") }}';
    console.log('üåê URL del endpoint:', url);

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        console.log('üì° Respuesta del servidor:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('üìä Datos recibidos:', data);
        // El polling se encargar√° de detectar cuando termine
        if (!data.success) {
            console.error('‚ùå Error en el procesamiento:', data.message);
            isProcessing = false;
            stopPolling();
            processingModal.hide();
            showAlert('error', data.message);
        } else {
            console.log('‚úÖ Procesamiento iniciado correctamente');
        }
    })
    .catch(error => {
        isProcessing = false;
        stopPolling();
        processingModal.hide();
        console.error('üí• Error en fetch:', error);
        showAlert('error', 'Error durante el procesamiento: ' + error.message);
    });
}

// Hacer funciones disponibles globalmente
window.processPending = processPending;

document.addEventListener('DOMContentLoaded', function() {
    processingModal = new bootstrap.Modal(document.getElementById('processing-modal'));

    // Arreglar la barra de progreso si ya est√° al 100%
    const mainProgressBar = document.getElementById('progress-bar');
    if (mainProgressBar) {
        const currentWidth = parseFloat(mainProgressBar.style.width);
        if (currentWidth >= 100) {
            console.log('üîß Arreglando barra de progreso al 100%');
            mainProgressBar.style.background = 'linear-gradient(90deg, #198754, #0f5132)';
            mainProgressBar.style.backgroundColor = '#198754';
            mainProgressBar.style.backgroundImage = 'none';
            mainProgressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
            mainProgressBar.classList.add('complete');
        }
    }
});

function refreshStats() {
    fetch('{{ url_for("embeddings.get_stats") }}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                document.getElementById('total-count').textContent = stats.total;
                document.getElementById('processed-count').textContent = stats.processed;
                document.getElementById('pending-count').textContent = stats.pending;
                document.getElementById('failed-count').textContent = stats.failed;
            } else {
                showAlert('error', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error al actualizar estad√≠sticas');
        });
}

function startPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }

    pollingInterval = setInterval(updateStatsRealTime, 2000); // Cada 2 segundos
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

function updateStatsRealTime() {
    fetch('{{ url_for("embeddings.get_stats") }}', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const stats = data.stats;

            // Actualizar n√∫meros en las tarjetas
            document.getElementById('total-count').textContent = stats.total;
            document.getElementById('processed-count').textContent = stats.processed;
            document.getElementById('pending-count').textContent = stats.pending;
            document.getElementById('failed-count').textContent = stats.failed;

            // Actualizar barra de progreso principal
            const mainProgressBar = document.getElementById('progress-bar');
            if (mainProgressBar) {
                const percentage = stats.total > 0 ? (stats.processed / stats.total * 100) : 0;
                mainProgressBar.style.width = percentage + '%';
                mainProgressBar.setAttribute('aria-valuenow', percentage);

                // Cambiar estilo seg√∫n el progreso
                mainProgressBar.classList.remove('complete', 'processing');
                if (percentage >= 100) {
                    mainProgressBar.classList.add('complete');
                    // Forzar el estilo verde cuando est√© completo
                    mainProgressBar.style.background = 'linear-gradient(90deg, #198754, #0f5132)';
                    mainProgressBar.style.backgroundColor = '#198754';
                    mainProgressBar.style.backgroundImage = 'none';
                    mainProgressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                } else if (isProcessing) {
                    mainProgressBar.classList.add('processing');
                    mainProgressBar.style.background = '';
                    mainProgressBar.style.backgroundColor = '';
                    mainProgressBar.style.backgroundImage = '';
                    if (!mainProgressBar.classList.contains('progress-bar-striped')) {
                        mainProgressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
                    }
                }
            }

            // Actualizar barra de progreso en el modal
            if (isProcessing) {
                const progressBar = document.getElementById('processing-progress');
                const progressText = document.getElementById('processing-message');

                if (progressBar) {
                    progressBar.style.width = stats.progress_percentage + '%';
                    progressBar.setAttribute('aria-valuenow', stats.progress_percentage);

                    // Estilo suave para la barra del modal tambi√©n
                    progressBar.classList.remove('complete', 'processing');
                    if (stats.progress_percentage >= 100) {
                        progressBar.classList.add('complete');
                    } else {
                        progressBar.classList.add('processing');
                    }
                }

                if (progressText) {
                    progressText.textContent = `Procesando embeddings... ${stats.processed}/${stats.total} (${stats.progress_percentage}%)`;
                }

                // Si termin√≥ el procesamiento
                if (stats.pending === 0 && stats.processed > 0) {
                    isProcessing = false;
                    stopPolling();
                    processingModal.hide();
                    showAlert('success', `‚úÖ Se procesaron ${stats.processed} embeddings correctamente`);
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            }
        }
    })
    .catch(error => {
        console.error('Error al actualizar estad√≠sticas:', error);
    });
}

function processSingle(imageId) {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;

    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;

    fetch(`{{ url_for("embeddings.process_single", image_id="") }}${imageId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showAlert('error', data.message);
            button.innerHTML = originalHtml;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Error al procesar imagen');
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}

function clearFailed() {
    const failedCount = parseInt(document.getElementById('failed-count').textContent);

    if (failedCount === 0) {
        showAlert('warning', 'No hay errores para limpiar');
        return;
    }

    if (!confirm(`¬øLimpiar ${failedCount} errores?\n\nLas im√°genes quedar√°n listas para reprocesar.`)) {
        return;
    }

    fetch('{{ url_for("embeddings.clear_failed") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Error al limpiar errores');
    });
}

function resetAll() {
    const totalCount = parseInt(document.getElementById('total-count').textContent);

    if (totalCount === 0) {
        showAlert('warning', 'No hay im√°genes para resetear');
        return;
    }

    if (!confirm(`‚ö†Ô∏è ¬øRESETEAR TODOS LOS EMBEDDINGS?\n\nEsto eliminar√° ${totalCount} embeddings existentes.\n\n¬øEst√°s seguro?`)) {
        return;
    }

    fetch('{{ url_for("embeddings.reset_all") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Error al resetear embeddings');
    });
}

function retryImage(imageId) {
    processSingle(imageId);
}

function viewLogs() {
    showAlert('info', 'Funci√≥n de logs en desarrollo');
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Detectar cuando el usuario abandona la p√°gina para limpiar polling
window.addEventListener('beforeunload', function() {
    stopPolling();
});
</script>
{% endblock %}
