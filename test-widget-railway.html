<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLIP Widget - Railway Production</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            margin: 20px 0;
        }
        .upload-area:hover {
            background: #e3f2fd;
            border-color: #0056b3;
        }
        .upload-area.dragover {
            background: #e3f2fd;
            border-color: #0056b3;
        }
        #fileInput {
            display: none;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .control-group label {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }
        select, button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .results {
            margin-top: 30px;
        }
        .result-item {
            display: flex;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            background: #f9f9f9;
            align-items: center;
        }
        .result-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }
        .result-info h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .result-info p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        .similarity-score {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .search-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            color: #495057;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç CLIP Widget - Railway Production</h1>
        <div class="search-info">
            <strong>Sistema de B√∫squeda Visual CLIP V2</strong><br>
            Servidor: <span id="serverUrl">Configurando...</span><br>
            Estado: <span id="status">Conectando...</span>
        </div>

        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>üì∏ Arrastra una imagen aqu√≠ o haz click para seleccionar</p>
            <p style="font-size: 12px; color: #666;">Formatos: JPG, PNG, WEBP</p>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="limitSelect">N√∫mero de resultados:</label>
                <select id="limitSelect">
                    <option value="3">3 productos</option>
                    <option value="5" selected>5 productos</option>
                    <option value="8">8 productos</option>
                    <option value="10">10 productos</option>
                    <option value="15">15 productos</option>
                </select>
            </div>

            <div class="control-group">
                <label for="thresholdSelect">Umbral de similitud:</label>
                <select id="thresholdSelect">
                    <option value="0.0">0.0 (Todo)</option>
                    <option value="0.1">0.1 (Muy bajo)</option>
                    <option value="0.2">0.2 (Bajo)</option>
                    <option value="0.3" selected>0.3 (Medio)</option>
                    <option value="0.4">0.4 (Alto)</option>
                    <option value="0.5">0.5 (Muy alto)</option>
                    <option value="0.6">0.6 (Extremo)</option>
                    <option value="0.7">0.7 (Perfecto)</option>
                </select>
            </div>

            <button onclick="searchSimilar()" id="searchBtn" disabled>
                üîç Buscar Similares
            </button>
        </div>

        <div class="loading" id="loading">
            <p>üîÑ Procesando imagen con CLIP...</p>
        </div>

        <div class="results" id="results"></div>
    </div>

    <script>
        // CONFIGURACI√ìN - URL de Railway
        let SERVER_URL = 'https://clipcomparadorv2-production.up.railway.app';

        // Detectar si estamos en desarrollo local
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            SERVER_URL = 'http://127.0.0.1:5000';
            document.getElementById('serverUrl').textContent = 'Desarrollo Local (localhost:5000)';
        } else {
            document.getElementById('serverUrl').innerHTML = '<span style="color: #28a745;">Railway Production</span>';
        }

        let selectedFile = null;

        // Configurar drag & drop
        const uploadArea = document.querySelector('.upload-area');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (!file.type.startsWith('image/')) {
                showError('Por favor selecciona un archivo de imagen v√°lido.');
                return;
            }

            selectedFile = file;
            document.getElementById('searchBtn').disabled = false;

            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadArea.innerHTML = `
                    <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                    <p style="margin-top: 10px;">üì∏ ${file.name}</p>
                    <p style="font-size: 12px; color: #666;">Click para cambiar imagen</p>
                `;
            };
            reader.readAsDataURL(file);
        }

        async function searchSimilar() {
            if (!selectedFile) {
                showError('Por favor selecciona una imagen primero.');
                return;
            }

            const limit = document.getElementById('limitSelect').value;
            const threshold = document.getElementById('thresholdSelect').value;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            document.getElementById('searchBtn').disabled = true;

            try {
                // Verificar conexi√≥n primero
                await testConnection();

                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('limit', limit);
                formData.append('threshold', threshold);

                const startTime = performance.now();

                const response = await fetch(`${SERVER_URL}/api/search`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': 'test-api-key-demo-fashion-store-2024'
                    },
                    body: formData
                });

                const endTime = performance.now();
                const searchTime = ((endTime - startTime) / 1000).toFixed(3);

                if (!response.ok) {
                    // Obtener detalles del error
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        console.error('Error data:', errorData);
                        
                        if (errorData.error === 'category_not_detected') {
                            showCategoryNotDetectedError(errorData, searchTime);
                            return;
                        } else {
                            throw new Error(`Error ${response.status}: ${errorData.message || errorData.error || response.statusText}`);
                        }
                    } catch (parseError) {
                        throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                    }
                }

                const data = await response.json();
                displayResults(data.results, searchTime, data.query_info);

            } catch (error) {
                console.error('Error en b√∫squeda:', error);
                showError(`Error de conexi√≥n: ${error.message}`);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
            }
        }

        async function testConnection() {
            try {
                const response = await fetch(`${SERVER_URL}/`, {
                    method: 'GET',
                    timeout: 5000
                });

                if (response.ok) {
                    document.getElementById('status').innerHTML = '<span style="color: #28a745;">‚úÖ Conectado</span>';
                } else {
                    throw new Error('Servidor no responde correctamente');
                }
            } catch (error) {
                document.getElementById('status').innerHTML = '<span style="color: #dc3545;">‚ùå Sin conexi√≥n</span>';
                throw error;
            }
        }

        function displayResults(results, searchTime, queryInfo) {
            const resultsDiv = document.getElementById('results');

            if (results.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>üîç Sin resultados</h3>
                        <p>No se encontraron productos similares con el umbral seleccionado.</p>
                        <p>Prueba con un umbral m√°s bajo o una imagen diferente.</p>
                    </div>
                `;
                return;
            }

            // Informaci√≥n de categor√≠a detectada
            let categoryInfo = '';
            if (queryInfo && queryInfo.detected_category) {
                categoryInfo = `
                    <div class="category-detected" style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #2e7d32;">üéØ Categor√≠a Detectada</h4>
                        <p style="margin: 0;"><strong>Categor√≠a:</strong> ${queryInfo.detected_category}</p>
                        <p style="margin: 5px 0 0 0;"><strong>Confianza:</strong> ${(queryInfo.confidence * 100).toFixed(1)}%</p>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">‚úÖ B√∫squeda filtrada autom√°ticamente por esta categor√≠a</p>
                    </div>
                `;
            }

            let html = `
                ${categoryInfo}
                <div class="success">
                    <h3>‚úÖ B√∫squeda completada</h3>
                    <p><strong>Tiempo:</strong> ${searchTime}s | <strong>Resultados:</strong> ${results.length} productos</p>
                </div>
                <h3>üìä Productos similares encontrados:</h3>
            `;

            results.forEach((result, index) => {
                const similarity = (result.similarity * 100).toFixed(1);
                html += `
                    <div class="result-item">
                        <img src="${result.image_url}" alt="${result.name}" class="result-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+SW1hZ2VuPC90ZXh0Pjwvc3ZnPg=='" />
                        <div class="result-info">
                            <h3>${result.name}</h3>
                            <p><strong>Categor√≠a:</strong> ${result.category || 'Sin categor√≠a'}</p>
                            <p><strong>Descripci√≥n:</strong> ${result.description || 'Sin descripci√≥n'}</p>
                            <p><strong>SKU:</strong> ${result.sku || 'N/A'} | <strong>Precio:</strong> ${result.price ? '$' + result.price : 'No disponible'}</p>
                            <p><strong>Stock:</strong> ${result.stock || 0} unidades</p>
                            <span class="similarity-score">${similarity}% similar</span>
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        function showError(message) {
            document.getElementById('results').innerHTML = `
                <div class="error">
                    <h3>‚ùå Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        function showCategoryNotDetectedError(data, searchTime) {
            const categoriesList = data.available_categories ? 
                data.available_categories.map(cat => `<li>${cat}</li>`).join('') : '';
            
            const clientName = data.client_name || 'este cliente';
            const processingTime = data.processing_time || searchTime;
            
            document.getElementById('results').innerHTML = `
                <div class="error" style="background: #fff3cd; border-color: #ffeaa7; color: #856404;">
                    <h3>ü§î Categor√≠a No Reconocida</h3>
                    <p><strong>${data.message}</strong></p>
                    <p>${data.details}</p>
                    <p><strong>Tiempo de procesamiento:</strong> ${processingTime}s</p>
                    
                    ${categoriesList ? `
                        <div style="margin-top: 15px;">
                            <strong>Categor√≠as disponibles para ${clientName}:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${categoriesList}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong>üí° Sugerencias:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>Prueba con una imagen m√°s clara de la categor√≠a deseada</li>
                            <li>Aseg√∫rate de que el producto est√© bien centrado en la imagen</li>
                            <li>Intenta con una imagen de fondo neutro</li>
                            <li>El producto debe ser claramente visible y reconocible</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Test de conexi√≥n al cargar
        window.addEventListener('load', () => {
            if (SERVER_URL !== 'RAILWAY_URL_PLACEHOLDER') {
                testConnection().catch(() => {
                    // Error manejado en testConnection
                });
            } else {
                document.getElementById('status').innerHTML = '<span style="color: #ffc107;">‚ö†Ô∏è URL no configurada</span>';
            }
        });
    </script>
</body>
</html>
